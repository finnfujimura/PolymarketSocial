New Feature Implementation Guide (v5 Polish)

This document provides the technical instructions for an engineering LLM to add three high-impact polish features to the existing "v3 - Wallet Auth" project.

This guide also includes the removal of the NFT prize feature to simplify the MVP.

1. Feature 1: "Rich" Bot Messages (HTML)

Goal: Upgrade the plain-text bot messages to rich HTML, showing colors and deep-links.

1.1. Backend (bot.ts)

In the "Squad Bot" service (Step 3.2 of projectplan.md):

Modify Bot Logic: When the bot polls GET /activity and finds a new trade (tx), it must also fetch the user.username from the public.users table (based on the polymarketUserAddress).

Format HTML Message: The bot must now generate an HTML string as the message content.

Set a color variable: const color = tx.side === 'BUY' ? '#4ade80' : '#f87171'; (green/red).

Construct the HTML content string. This string must be saved to the chat_messages.content column.

<!-- Example HTML content to save in the database: -->
<p>
  ðŸ¤– <strong>${username}</strong> just
  <span style="color: ${color}; font-weight: bold;">${tx.side}</span>
  <strong>$${tx.usdcSize.toFixed(2)}</strong> of "${tx.outcome}" in
  <a href="[https://polymarket.com/event/$](https://polymarket.com/event/$){tx.slug}" target="_blank" style="color: #60a5fa; text-decoration: underline;">
    ${tx.title}
  </a>
</p>


1.2. Frontend (Chat Component)

In the component responsible for rendering chat_messages:

Render HTML: Locate the part of your code that renders message.content.

It must be changed from rendering plain text to using React's dangerouslySetInnerHTML.

Example: <div dangerouslySetInnerHTML={{ __html: message.content }} />

Security: This is safe only because this content field is generated by our trusted backend bot or is plain text from a user.

2. Feature 2: Leaderboard "Top Position" Drilldown

Goal: Upgrade the leaderboard to show each user's single best-performing open position.

2.1. Backend (GET /api/squads/:id/leaderboard)

In the projectplan.md (Step 4.1), modify the leaderboard logic:

Find Top Position: When the API is looping through a user's positions (from GET /positions) to sum the totalLivePnl:

Simultaneously find the single position with the highest cashPnl.

Store this as a topPosition object: { title: string, cashPnl: number, outcome: string }.

Modify Response: Add this topPosition object to the LeaderboardEntry for that user.

The final results array should now look like: [{ user, totalLivePnl, rank, topPosition }, ...].

If a user has no open positions, topPosition should be null.

2.2. Frontend (Leaderboard Component)

Display New Data: In the UI component that renders the leaderboard, add a new element under each user's totalLivePnl.

Render: Display the entry.topPosition.title and entry.topPosition.cashPnl.

Handle Null: Add a check to render nothing (or "No open positions") if entry.topPosition is null.

2.3. API (api.md)

The LeaderboardEntry interface in api.md (Section 1) must be updated to reflect this new data:

// A single entry on the leaderboard
interface LeaderboardEntry {
  user: User;
  totalLivePnl: number;   // Sum of `cashPnl` from all positions
  rank: number;
  // (NEW) The user's single best open position
  topPosition?: {
    title: string;
    cashPnl: number;
    outcome: string;
  }
}


3. Feature 3: Live Leaderboard Refresh

Goal: Make the leaderboard UI update automatically when the bot posts a new trade.

3.1. Backend (bot.ts)

In the "Squad Bot" service (Step 3.2):

Emit New Event: After the bot successfully broadcasts the "chat:receive" message to a squadId room, it must immediately emit a second event to that same room.

Code: io.to(squadId).emit("leaderboard:refresh");

3.2. Frontend (Leaderboard Component)

In the frontend component(s) responsible for fetching leaderboard data:

Add Socket Listener: Add a new Socket.IO listener that listens for this event.

Code: socket.on("leaderboard:refresh", () => { ... });

Trigger Refresh: The callback function for this listener must call the exact same data-fetching function that your "Refresh" button (Step 4.1) uses. This will trigger an automatic re-fetch and re-render of the leaderboard.

3.3. API (api.md)

The api.md file (Section 4, Server -> Client) must be updated to document this new event:

"(NEW) leaderboard:refresh"
* **Description:** Sent by the server *after* the bot posts a new trade, telling the frontend to re-fetch the leaderboard automatically.
* **Payload:** `void` (No payload, it's just a trigger)


4. Feature Removal: Gasless NFT Prize

To simplify the MVP, all logic related to the "Squad MVP" NFT prize is removed.

4.1. projectplan.md

DELETE the following sections and sub-steps:

Section 4) Leaderboard & NFT Prize -> DELETE Step 4.2 "Squad MVP" logic.

Section 4) Leaderboard & NFT Prize -> DELETE Step 4.3 Gasless NFT mint.

Section 5) DEMO DAY GUARDRAILS -> DELETE Step 5.2 "Fake Mint" Flow.

Section 5) DEMO DAY GUARDRAILS -> Renumber 5.3 to 5.2.

4.2. api.md

DELETE the following from Section 3) Backend REST API Endpoints:

POST /api/squads/claim-prize

4.3. schema.sql

The squad_winners table is no longer required and can be deleted from the schema.